<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | PANEL ASISTENTE ‚ú¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&display=swap');
        :root { --kb-gold: #c5a059; --kb-dark: #0f172a; --kb-bg: #f8f9fa; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--kb-bg); height: 100vh; overflow: hidden; display: flex; padding: 1rem; gap: 1rem; }
        .glass { background: white; border: 1px solid rgba(197, 160, 89, 0.1); border-radius: 2.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .fc-event { border: none !important; border-radius: 8px !important; padding: 4px !important; cursor: pointer; font-weight: 700; font-size: 10px; }
        /* Colores por Estado del nuevo esquema */
        .event-confirmada { border-left: 5px solid #10b981 !important; background: #ecfdf5 !important; color: #065f46 !important; }
        .event-pendiente { border-left: 5px solid #f59e0b !important; background: #fffbeb !important; color: #92400e !important; }
        #sidebar { width: 300px; background: white; border-radius: 2.5rem; padding: 2rem; border: 1px solid #f1f5f9; }
        .input-luxe { width: 100%; padding: 0.8rem; border-radius: 1rem; border: 1px solid #e2e8f0; outline: none; font-size: 0.8rem; }
        .modal-blur { backdrop-filter: blur(15px); background: rgba(15, 23, 42, 0.4); }
    </style>
</head>
<body>
    <div class="flex-1 flex flex-col gap-4">
        <header class="glass p-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white font-black italic">KB</div>
                <h1 class="text-xl font-black italic uppercase text-slate-900">K.B <span class="text-[#c5a059]">SYSTEM</span></h1>
            </div>
            <select id="doctorSelect" class="input-luxe w-48 text-[10px] font-black uppercase text-slate-400"></select>
            <button onclick="copiarLink()" class="bg-[#c5a059] text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase">üîó Copiar Link</button>
        </header>
        <div class="flex-1 glass p-6 overflow-hidden"><div id="calendar" class="h-full"></div></div>
    </div>

    <div id="modalCita" class="fixed inset-0 hidden modal-blur flex items-center justify-center z-[9999] p-4">
        <div class="bg-white max-w-md w-full p-8 rounded-[2.5rem] shadow-2xl border border-[#c5a059]">
            <h2 class="text-xl font-black uppercase italic mb-6 border-b pb-2">Gesti√≥n <span class="text-[#c5a059]">Cita</span></h2>
            <div class="space-y-4">
                <input id="c-paciente" class="input-luxe" placeholder="NOMBRE PACIENTE">
                <input id="c-telefono" class="input-luxe" placeholder="TEL√âFONO">
                <div class="grid grid-cols-2 gap-2"><input type="date" id="c-fecha" class="input-luxe"><input type="time" id="c-hora" class="input-luxe"></div>
                <select id="c-estado" class="input-luxe font-black uppercase text-[10px]">
                    <option value="pendiente">‚è≥ Pendiente</option>
                    <option value="confirmada">‚úì Confirmada</option>
                    <option value="cancelada">üö´ Cancelada</option>
                    <option value="completada">‚ú¶ Completada</option>
                </select>
                <button onclick="enviarWhatsApp()" class="w-full py-3 bg-emerald-500 text-white rounded-xl font-black text-[10px] uppercase">üì± Enviar WhatsApp</button>
                <textarea id="c-notas" class="input-luxe h-20" placeholder="NOTAS..."></textarea>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="guardarCita()" class="flex-1 py-4 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase">Actualizar</button>
                <button onclick="cerrarModal()" class="px-6 py-4 text-[10px] font-black text-slate-400 uppercase">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient('https://hymwekomndkxdxsxqhyq.supabase.co', 'sb_publishable_5ePDm7jC3nNnMPeM9BuADg_bvoE0kI_');
        let calendar, doctorActual = null;

        async function init() {
            const { data: docs } = await supabase.from('doctores').select('*').eq('clinica_id', localStorage.getItem('clinica_id'));
            const select = document.getElementById('doctorSelect');
            select.innerHTML = docs.map(d => `<option value="${d.id}">${d.nombre_profesional.toUpperCase()}</option>`).join('');
            doctorActual = select.value;
            select.onchange = (e) => { doctorActual = e.target.value; calendar.refetchEvents(); };
            initCalendar();
        }

        function initCalendar() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                locale: 'es', initialView: 'timeGridDay', slotMinTime: "08:00:00", slotMaxTime: "21:00:00",
                events: async (info, success) => {
                    const { data } = await supabase.from('citas_agenda').select('*, pacientes(*)').eq('doctor_id', doctorActual);
                    success(data.map(c => ({
                        id: c.id, title: c.pacientes.nombre_completo, start: `${c.fecha}T${c.hora_inicio}`,
                        classNames: [`event-${c.estado}`], extendedProps: c
                    })));
                },
                dateClick: (info) => { abrirModal(null, info.dateStr); },
                eventClick: (info) => { abrirModal(info.event.extendedProps); }
            });
            calendar.render();
        }

        window.abrirModal = (cita, dateStr) => {
            const modal = document.getElementById('modalCita');
            modal.classList.remove('hidden');
            if(cita) {
                document.getElementById('c-paciente').value = cita.pacientes.nombre_completo;
                document.getElementById('c-telefono').value = cita.pacientes.telefono;
                document.getElementById('c-fecha').value = cita.fecha;
                document.getElementById('c-hora').value = cita.hora_inicio.slice(0,5);
                document.getElementById('c-estado').value = cita.estado;
            } else {
                document.getElementById('c-fecha').value = dateStr.split('T')[0];
                document.getElementById('c-hora').value = dateStr.split('T')[1]?.slice(0,5) || "09:00";
            }
        };

        window.cerrarModal = () => document.getElementById('modalCita').classList.add('hidden');
        
        window.guardarCita = async () => {
            // L√≥gica para upsert paciente y guardar cita_agenda
            const tel = document.getElementById('c-telefono').value;
            const { data: p } = await supabase.from('pacientes').upsert({
                clinica_id: localStorage.getItem('clinica_id'),
                nombre_completo: document.getElementById('c-paciente').value.toUpperCase(),
                telefono: tel
            }).select().single();

            await supabase.from('citas_agenda').insert({
                clinica_id: localStorage.getItem('clinica_id'),
                doctor_id: doctorActual,
                paciente_id: p.id,
                fecha: document.getElementById('c-fecha').value,
                hora_inicio: document.getElementById('c-hora').value,
                duracion_minutos: 30,
                estado: document.getElementById('c-estado').value
            });
            calendar.refetchEvents();
            cerrarModal();
        };

        window.copiarLink = () => {
            const url = `${window.location.origin}/agendar.html?docId=${doctorActual}&clinId=${localStorage.getItem('clinica_id')}`;
            navigator.clipboard.writeText(url);
            alert("LINK COPIADO ‚ú¶");
        };

        init();
    </script>
</body>
</html>
