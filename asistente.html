<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.B SYSTEM | ASISTENTE √âLITE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <style>
        :root {
            --luxe-gold: #c5a059;
            --luxe-gold-hover: #b08d4a;
            --bg-body: #f8fafc;
        }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: #0f172a;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-luxe {
            background-color: #ffffff;
            border-radius: 2.5rem;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            border: 1px solid rgba(197, 160, 89, 0.1);
        }

        .input-luxe {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            outline: none;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #334155;
        }
        .input-luxe:focus {
            border-color: var(--luxe-gold);
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
            background-color: #ffffff;
        }

        .btn-gold {
            background-color: var(--luxe-gold);
            color: white;
            transition: all 0.3s;
        }
        .btn-gold:hover {
            background-color: var(--luxe-gold-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(197, 160, 89, 0.4);
        }

        .fc { font-family: 'Plus Jakarta Sans', sans-serif; }
        .fc-toolbar-title { font-weight: 900 !important; text-transform: uppercase; color: #0f172a; font-size: 1.5rem !important; }
        .fc-button-primary {
            background-color: #ffffff !important;
            color: #475569 !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 0.8rem !important;
            font-weight: 800 !important;
            text-transform: uppercase;
            font-size: 0.75rem !important;
            padding: 0.5rem 1rem !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        }
        .fc-button-primary:hover, .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--luxe-gold) !important;
            color: white !important;
        }

        .estado-confirmada { background-color: #10b981 !important; color: white !important; }
        .estado-pendiente { background-color: #f59e0b !important; color: white !important; }
        .estado-cancelada { background-color: #ef4444 !important; color: white !important; }
        .estado-completada { background-color: #3b82f6 !important; color: white !important; }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }
        
        .modal-content {
            transform: scale(0.95) translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-backdrop.active .modal-content { transform: scale(1) translateY(0); opacity: 1; }
    </style>
</head>
<body class="p-6 gap-6">

    <header class="panel-luxe p-6 flex justify-between items-center z-10">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center shadow-lg shadow-slate-900/20">
                <span class="text-[#c5a059] font-black text-2xl">‚ú¶</span>
            </div>
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tighter">K.B <span class="text-[#c5a059]">SYSTEM</span></h1>
                <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Panel Asistente √âlite</p>
            </div>
        </div>

        <div class="flex items-center gap-4 w-96">
            <select id="doctorSelect" class="input-luxe cursor-pointer text-sm uppercase tracking-wide">
                <option value="">Cargando Doctores...</option>
            </select>
        </div>
    </header>

    <main class="flex-1 panel-luxe p-8 overflow-hidden relative flex flex-col">
        <div id="calendar" class="flex-1"></div>
    </main>

    <div id="citaModal" class="modal-backdrop">
        <div class="modal-content panel-luxe w-full max-w-2xl p-8 relative overflow-hidden bg-white">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="modalTitle" class="text-xl font-black uppercase tracking-tight">Agendar Cita</h2>
                </div>
                <button onclick="cerrarModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 font-bold">‚úï</button>
            </div>

            <form id="citaForm" class="space-y-4">
                <input type="hidden" id="citaId">
                <input type="hidden" id="pacienteId">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Fecha</label>
                        <input type="date" id="fechaCita" class="input-luxe" required readonly>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Hora Inicio</label>
                        <input type="time" id="horaInicio" class="input-luxe" required>
                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                    <input type="tel" id="telefonoPaciente" placeholder="TEL√âFONO" class="input-luxe" required>
                    <input type="text" id="nombrePaciente" placeholder="NOMBRE COMPLETO" class="input-luxe" required>
                    <input type="email" id="emailPaciente" placeholder="EMAIL (OPCIONAL)" class="input-luxe">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <select id="servicioSelect" class="input-luxe" required></select>
                    <select id="estadoCita" class="input-luxe font-bold" required>
                        <option value="pendiente">Pendiente</option>
                        <option value="confirmada">Confirmada</option>
                        <option value="completada">Completada</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>

                <div class="pt-6 flex gap-4 mt-6">
                    <button type="button" id="btnWhatsapp" class="hidden flex-1 py-3 px-4 bg-emerald-50 text-emerald-600 border border-emerald-200 font-black text-[11px] uppercase rounded-xl">üì≤ WhatsApp</button>
                    <button type="submit" id="btnGuardar" class="flex-1 py-3 px-4 btn-gold font-black text-[11px] uppercase rounded-xl">Guardar Operaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient('https://hymwekomndkxdxsxqhyq.supabase.co', 'sb_publishable_5ePDm7jC3nNnMPeM9BuADg_bvoE0kI_');

        let calendar;
        let clinica_id = localStorage.getItem('clinica_id') || 'cc1fad06-c67f-47e1-8bb3-c31bdd4966d1';
        let serviciosActuales = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarDoctores();
            inicializarCalendario();
            
            document.getElementById('doctorSelect').addEventListener('change', async (e) => {
                await cargarServicios(e.target.value);
                calendar.refetchEvents();
            });

            document.getElementById('citaForm').addEventListener('submit', guardarCita);
        });

        async function cargarDoctores() {
            const select = document.getElementById('doctorSelect');
            const { data, error } = await supabase
                .from('doctores')
                .select('id, nombre_profesional')
                .eq('clinica_id', clinica_id);

            if (data && data.length > 0) {
                select.innerHTML = data.map(d => `<option value="${d.id}">‚öïÔ∏è DR. ${d.nombre_profesional}</option>`).join('');
                await cargarServicios(data[0].id);
            } else {
                select.innerHTML = '<option value="">No hay doctores registrados</option>';
            }
        }

        async function cargarServicios(doctorId) {
            const select = document.getElementById('servicioSelect');
            const { data } = await supabase
                .from('servicios')
                .select('id, nombre, duracion_minutos')
                .eq('doctor_id', doctorId);

            if (data) {
                serviciosActuales = data;
                select.innerHTML = data.map(s => `<option value="${s.id}">${s.nombre} (${s.duracion_minutos} min)</option>`).join('');
            }
        }

        function inicializarCalendario() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                locale: 'es',
                initialView: 'timeGridWeek',
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
                events: async (info, success) => {
                    const docId = document.getElementById('doctorSelect').value;
                    if (!docId) return success([]);

                    const { data } = await supabase
                        .from('citas_agenda')
                        .select('id, fecha, hora_inicio, duracion_minutos, estado, pacientes(nombre_completo, telefono), servicios(nombre)')
                        .eq('doctor_id', docId);

                    success(data.map(c => ({
                        id: c.id,
                        title: `${c.pacientes?.nombre_completo || 'Paciente'}`,
                        start: `${c.fecha}T${c.hora_inicio}`,
                        end: new Date(new Date(`${c.fecha}T${c.hora_inicio}`).getTime() + c.duracion_minutos * 60000),
                        className: `estado-${c.estado}`,
                        extendedProps: c
                    })));
                },
                select: (info) => abrirModalCrear(info.start),
                eventClick: (info) => abrirModalEditar(info.event),
                selectable: true
            });
            calendar.render();
        }

        window.abrirModalCrear = (fechaObj) => {
            document.getElementById('citaForm').reset();
            document.getElementById('citaId').value = '';
            document.getElementById('fechaCita').value = fechaObj.toISOString().split('T')[0];
            document.getElementById('horaInicio').value = fechaObj.toTimeString().substring(0, 5);
            document.getElementById('citaModal').classList.add('active');
        };

        window.abrirModalEditar = (event) => {
            const p = event.extendedProps;
            document.getElementById('citaId').value = p.id;
            document.getElementById('fechaCita').value = p.fecha;
            document.getElementById('horaInicio').value = p.hora_inicio.substring(0, 5);
            document.getElementById('nombrePaciente').value = p.pacientes.nombre_completo;
            document.getElementById('telefonoPaciente').value = p.pacientes.telefono;
            document.getElementById('servicioSelect').value = p.servicios.id;
            document.getElementById('estadoCita').value = p.estado;
            document.getElementById('citaModal').classList.add('active');
        };

        window.cerrarModal = () => document.getElementById('citaModal').classList.remove('active');

        async function guardarCita(e) {
            e.preventDefault();
            const btn = document.getElementById('btnGuardar');
            btn.innerText = "PROCESANDO...";

            const doctor_id = document.getElementById('doctorSelect').value;
            const tel = document.getElementById('telefonoPaciente').value;
            const nombre = document.getElementById('nombrePaciente').value;
            const servicio_id = document.getElementById('servicioSelect').value;

            let { data: pac } = await supabase.from('pacientes').select('id').eq('telefono', tel).maybeSingle();
            if (!pac) {
                const { data: nPac } = await supabase.from('pacientes').insert({ clinica_id, nombre_completo: nombre, telefono: tel }).select().single();
                pac = nPac;
            }

            const payload = {
                clinica_id,
                doctor_id,
                paciente_id: pac.id,
                servicio_id,
                fecha: document.getElementById('fechaCita').value,
                hora_inicio: document.getElementById('horaInicio').value,
                duracion_minutos: serviciosActuales.find(s => s.id == servicio_id)?.duracion_minutos || 30,
                estado: document.getElementById('estadoCita').value
            };

            const citaId = document.getElementById('citaId').value;
            if (citaId) await supabase.from('citas_agenda').update(payload).eq('id', citaId);
            else await supabase.from('citas_agenda').insert(payload);

            cerrarModal();
            calendar.refetchEvents();
            btn.innerText = "Guardar Operaci√≥n";
        }
    </script>
</body>
</html>
